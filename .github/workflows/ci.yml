name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Install Dependencies
        run: yarn install --ignore-engines

      - name: Run Node.js Application
        shell: powershell
        run: |
          # Start the Node.js process and redirect output to a log file
          npx ts-node src/index.ts | Tee-Object -FilePath output.log
          
      - name: Wait for the Node.js app to start
        run: Start-Sleep -Seconds 2  # Additiona

      - name: Check Connection to the Node.js API
        shell: powershell
        run: |
          # Extract the port number from the output
          $portLine = Get-Content output.log | Select-String -Pattern "Server is running on port"
          $port = $portLine -replace '.*port ', '' -replace '\D', '' # Ensure only the port number is left
          Write-Host "Testing connection on port: $port"
          
          # Check if the server is reachable using curl
          $response = curl -s -o /dev/null -w "%{http_code}" http://localhost:$port
          if ($response -ne 200) {
            Write-Error "Failed to connect. HTTP Status Code: $response"
            exit 1
          } else {
            Write-Host "Successfully connected to the server on port $port."
          }

      - name: Read Application Logs
        run: |
          echo "Output Log:"
          Get-Content output.log
          echo "Error Log:"
          Get-Content error.log